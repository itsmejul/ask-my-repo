<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Query UI</title>
    <style>
      body {
        background: #111;
        color: #0f0;
        font-family: monospace;
        display: flex;
        justify-content: center;
        padding: 2rem;
      }

      .container {
        width: 100%;
        max-width: 600px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      input[type="text"], textarea, button {
        width: 100%;
        background: #000;
        color: #0f0;
        border: 1px solid #0f0;
        padding: 0.5rem;
        font-family: monospace;
        font-size: 1rem;
      }

      textarea {
        resize: vertical;
        height: 100px;
      }

      button {
        cursor: pointer;
      }

        #spinner {
          border: 4px solid #f3f3f3;
          border-top: 4px solid #333;
          border-radius: 50%;
          width: 24px;
          height: 24px;
          animation: spin 1s linear infinite;
          display: none;
          margin-top: 10px;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

      #response {
        white-space: pre-wrap;
        font-family: monospace;
      }

      @media (max-width: 600px) {
        .container {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <input id="repo_url" type="text" placeholder="Repo url">
      <textarea id="query" placeholder="Query"></textarea>
      <button onclick="handleQuery()">Send</button>
      <div id="spinner"></div>
      <div id="response" style="white-space: pre-wrap; font-family: monospace;"></div>
    </div>
    <script>
      async function handleQuery() {
        const repo_url = document.getElementById('repo_url').value;
        const query = document.getElementById('query').value;

        // Trigger indexing
        await fetch('/api/start-indexing', { // Here we have to use localhost instead of gateway, because the frontend will be run in the browser (or my domain) and not in the container!
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: repo_url })
        });

        // Show spinner
        document.getElementById('spinner').style.display = 'inline-block';
        document.getElementById('response').innerHTML = "";

        // Poll status
        const pollInterval = 3000;
        const checkStatus = async () => {
          const res = await fetch('/api/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: repo_url })
          });

          const data = await res.json();
          if (data.status === 'done') {
            document.getElementById('spinner').style.display = 'none';
            queryRepo(repo_url, query);
          } else if (data.status === 'failed') {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('response').innerHTML = "Indexing failed.";
          } else {
            setTimeout(checkStatus, pollInterval);
          }
        };

        checkStatus();
      }

      async function queryRepo(repo_url, query) {
        const res = await fetch('/api/repo/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: repo_url, query })
        });

        const data = await res.json();
        document.getElementById('response').innerHTML = renderMarkdownLike(data.response);
      }

      function renderMarkdownLike(text) {
        text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        text = text.replace(/```([^`]+)```/gs, (_, code) =>
          `<pre><code>${code.trim()}</code></pre>`);
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        return text.replace(/\n/g, '<br>');
      }
    </script>
  </body>
</html>
